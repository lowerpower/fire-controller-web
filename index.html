<?php
?>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<link href="/css/uploadfile.css" rel="stylesheet">
<link href="/cssChanges.css" rel="stylesheet">

<!-- <script src="/js/jquery.min.js"></script> -->

<script src="/js/jquery-1.12.4.js"></script>

<script language="javascript" type="text/javascript">

//    const WebSocket = require('ws');
    
    var loc = window.location, new_uri;
    if (loc.protocol === "https:") {
        new_uri = "wss:";
    } else {
        new_uri = "ws:";
    }
    new_uri += "//" + loc.host + ":8080";
    new_uri += loc.pathname ;

    function next() {
      ws.send('set '+Math.floor((Math.random() * 0xffffffff) + 1));
    }

    var ws = new WebSocket(new_uri);

    console.log("websock connect to "+new_uri);

    ws.onclose = function() {
        console.log('DISCONNECT');
    };

    ws.onopen = function() {
        console.log('CONNECTED');
        ws.send('set 0');
    };

    ws.onmessage = function(data) {
      console.log('message');
      console.log("from websocket: ",data.data);

      // Update Grid
      update_grid("grid-",data.data);

      // try to play the next element of playlist
      playlist_play();

    };
/*
    socket.addEventListener('message', function (event) {
        console.log('Message from server ', event.data);
    });
*/

// padd zero (number, width, z set if not zero pad)
function pad(n, width, z) {
  z = z || '0';
  n = n + '';
  return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
}


var lastClicked;
var currentState1=0;
var currentState2=0;


function update_grid(grid_id,bitmask_str)
{
    var cell;
   
    var bitmask1        = 0;
    var bitmask2        = 0;
    var bitmask_string  = bitmask_str;

    if(bitmask_string.length>16)
        bitmask_string=bitmask_string.slice(-16);

    if(bitmask_string.length>0)
        bitmask1 = parseInt(bitmask_string.slice(-8),16);

    if(bitmask_string.length>8)
    {
        bitmask2 = parseInt(bitmask_string.slice(0,bitmask_string.length-8,),16);
    }

    //console.log("incoming bitmask = ",bitmask_string);
    //console.log("bitmask string 1 = ",pad(bitmask1.toString(16),8) );
    //console.log("bitmask string 2 = ",pad(bitmask2.toString(16),8) );


    // Loop and set grid
    for(i=1;i<=48;i++)
    {
        // get element in grid
        el = document.getElementById(grid_id+i);

        // check bitmask
        if(i<32)
        {
            if( bitmask1 & (1<<(i-33)) )
            {
                el.className='clicked';
            }
            else
            {
                el.className='';
            }
        }
        else
        {
            if( bitmask2 &  Math.abs(1<<(i-1))  )
            {
                el.className='clicked';
            }
            else
            {
                el.className='';
            }
        }
    }
}

var grid = clickableGrid(6,8,function(el,row,col,i){
    console.log("You clicked on element:",el);
    //console.log("You clicked on row:",row);
    //console.log("You clicked on col:",col);
    console.log("You clicked on item #:",i);
    console.log("item class name:",el.className);

    send_val=send_val2=0;
    if('clicked'==el.className)
    {
        el.className='';
        ws.send('set 0');
    }
    else
    {
        el.className='clicked';
        if(i>32)
        {
            send_val2=1<<(i-33);
        }
        else
        {
            send_val=Math.abs(1<<(i-1));
        }
        send_val_string= pad(send_val.toString(16),8);
        send_val_string2= pad(send_val2.toString(16),8);
        
    //    console.log("setting bitmask:",send_val_string);
    //    console.log("setting bitmask2:",send_val_string2);
        console.log("setting command: set ",send_val_string2+send_val_string);

        
        ws.send('set '+send_val_string2+send_val_string);
    }
    
    if ((lastClicked)&&(lastClicked!=el)) lastClicked.className='';
    lastClicked = el;
});

     
function clickableGrid( rows, cols, callback ){
    var i=0;
    var grid = document.createElement('table');
    grid.className = 'grid';
    for (var r=0;r<rows;++r){
        var tr = grid.appendChild(document.createElement('tr'));
        for (var c=0;c<cols;++c){
            var cell = tr.appendChild(document.createElement('td'));
            cell.id="grid-"+i;
            cell.innerHTML = ++i;
            cell.id="grid-"+i;
            cell.addEventListener('click',(function(el,r,c,i){
                return function(){
                    callback(el,r,c,i);
                }
            })(cell,r,c,i),false);
        }
    }
    return grid;
}

function click_dir(item)
{
    //console.log("clickdir: "+item);
    
    // append this item to the play queue
    playlist_item_append(item);

}

//
// Append an item to the end of the playlist
//
function playlist_item_append(item)
{
    var table = document.getElementById('play-table');

    var tr   = table.appendChild(document.createElement('tr'));
    var cell = tr.appendChild(document.createElement('td'));
    cell.innerHTML=item;
}


function playlist_item_delete()
{
    console.log("delete first");
    $('#play-table tr:first').remove();
}

function playlist_clear()
{
    playlist_paused=1;
    playlist_do_pause=0;
    current_play_file=[];

    $('#play-table tr').remove();
}


var current_play_file=[];
var playlist_do_pause=0;
var playlist_paused=1;

function playlist_play()
{
    if((playlist_do_pause) && (0==playlist_paused))
    {
        ws.send('set 0');
        playlist_paused=1;
        playlist_do_pause=0;
    }
    if(0==playlist_paused)
    {
        // pop off next line
        if(current_play_file.length>0)
        {
            // pop off next element and send it
            while(current_play_file.length)
            {
                data=current_play_file.shift();
                if(data.length>4)
                    break;
            }

            if(0==current_play_file.length)
            {
                // delete the top of the play list
                playlist_item_delete();    
                // call us again
                playlist_play(); 
            }
            else
            {
                ws.send(data);
                console.log("sending file line : ",data);
            }
        }
        else
        {
            // Get Next File, get name from top of list
            var id = $("#play-table").find("td:first").text();

            if(id.length)
            {
                $.ajax({
                  url: "/uploads/"+id,
                  success: function(data){
                    // load data into our play array
                    current_play_file=data.split("\n");  

                    // make sure not null
                    if(current_play_file.length>0)
                        playlist_play();         
                  },
                  cache: false,
                  error: function(textStatus, errorThrown){
                    alert('request playfile failed');
                  } 
                });
            }
            else
            {
                // empty, pause
                playlist_pause=1;
            }
        }
    }
}

function playlist_start()
{
    playlist_paused=0;
    playlist_play();           
}

function playlist_pause_action()
{
    // Set Pause Flag, engine will pause and send set 0
    playlist_do_pause=1;
}

function load_dir() 
{
    var i=0;
    var the_api_url = "/dir.php";

    var table = document.getElementById('data-table');
    $("#data-table").empty();
    table.className = 'dir';

    $.getJSON(the_api_url, {}, function(data) {
        $.each(data, function(idx, item){
            
            var tr   = table.appendChild(document.createElement('tr'));
            var cell = tr.appendChild(document.createElement('td'));
            console.log("item:",item);

            cell.innerHTML=item;
            cell.addEventListener('click',(function(item){
                return function(){
                    click_dir(item);
                }
            })(item),false);
            
            //console.log("data:",item);
        });
    });
}


function generate_random_bitmask_string(bits,max_bits_set)
{
    var bitmask = [];
    var bitmask_string;
    var rand_num;
    var index,max_index=0;
    var i;

    for (i = 0; i < 4; i++) bitmask[i] = 0;


    for(i=0;i<max_bits_set;i++)
    {
        rand_num=Math.ceil(Math.random()*bits);
        index=Math.ceil(rand_num/32)-1;

        console.log("index :"+index+"  rand: "+ rand_num);
    
        bitmask[index] |= (1<< ((rand_num-1)-(32*index))  );

        if(index>max_index)
            max_index=index;
    }

    //console.log("bitmask string 1 = ",pad(bitmask1.toString(16),8) );

    bitmask_string=bitmask[max_index--].toString(16);
    while(max_index>=0)
    {
        bitmask_string=bitmask_string+pad(bitmask[max_index--].toString(16),8);
    }
    console.log("final bitmask: ",bitmask_string);

    return(bitmask_string);

}

// unload function
window.onbeforeunload = function () {
    ws.send('set 0');
}

window.onload= function() {

    var theDiv = document.getElementById("grid1");
    theDiv.appendChild(grid);

    load_dir();


    //
    // Set the event buttons
    //

    //
    // Grid random and clear buttons
    //
    $('#btn-random').click(function() {
        ws.send('set '+Math.floor((Math.random() * 0xffffffffff) + 1)+' 5');
    });

    $('#btn-2random').click(function() {
        // set random 2 bits
        ws.send('set '+generate_random_bitmask_string(48,2)+' 5');
    });

    $('#btn-3random').click(function() {
        // set random 3 bits
        ws.send('set '+generate_random_bitmask_string(48,3)+' 5');
    });
    
    $('#btn-alloff').click(function(e) {
        // set the relays all off by sending a 'set 0' to the relay controller
        ws.send('set 0');
    });

    //
    // directory buttons
    //
    $('#btn-reload-dir').click(function(e) {
        // reload the riff file directory
        load_dir();
    });

    //
    // Play buttons
    //
    $('#btn-play').click(function(e) {
        // play the riffs queued in the playlist
        playlist_start();
    });
    //
    // pause
    //
    $('#btn-pause').click(function(e) {
        // pause the playlist from playing 
        playlist_pause_action();
        //playlist_item_delete();
    });
    //
    // Clear Playlist
    //
    $('#btn-clear').click(function(e) {
        // clear the playlist 
        playlist_clear(); 
    });

}

</script>
</head>


<body>

<div id="main-container">

  <div id="leftContent" >
    <div id="grid1"><h4 align="center">Relay Status - Single Clickable</h4>
    </div >
    <table>
      <tr><td>
        <br><br>
        <button id="btn-alloff">All Relays Off</button>&nbsp;
        <button id="btn-2random">2 Random</button>&nbsp;
        <button id="btn-3random">3 Random</button>&nbsp;
        <button id="btn-random">All Random</button>&nbsp;
        </td></tr>
    </table>
  </div>
  
  <div id="mainContent" >

    <h4 align="center">Riff Files - Click to Queue</h4>
    <button id="btn-reload-dir">Reload Dir</button>&nbsp;
    <br />
    
    <table id="data-table"></table>
  
  </div> 
  
  <div id="rightContent" >
  
    <h4 align="center">Play List</h4>
    <button id="btn-play">Play</button>&nbsp;
    <button id="btn-pause">Pause</button>&nbsp;
    <button id="btn-clear">Clear</button>&nbsp;
    <br />

    <table class="dir" id="play-table">
    </table>

    
  </div>

</div>

<br><br>
<h2><a href="fm">Riff Manager</a></h2>

</body>


</html>

